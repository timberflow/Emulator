# 这是一个形式上的标题

## 一些废话
真的是自己一步一步学的，写的，花了5天基本功能才完成。2021/10/4/19:49
使用语言是python就是我们之前学的，使用flask模块搭建完成。使用flask的原因是作业要求那里有一个flask的链接我就点进去看感觉还比较容易理解。本来我就没有一个完整的搭建web平台的经验，之前做的都是在别的sass的安装指示下玩成的。这次的实验理论上可以用我们之前web编程课的框架来做，但是那样的话主要代码就是JavaScript来写的，而且数据库就要用mysql，用法跟mongo好像还有点差别。再加上我确实比较想积累这方面的经验，就去自学了flask的用法，和之前学了跟没学一样的html写法。还好要求里说的界面简单，不然我还得去再学css。

## app基本说明
### 准备工作
首先要有一个安装了pymongo的终端，从shell进入app.py同级目录，运行:
```python
flask run
```
注意这是要求源代码文件名必须是app.py或者wsgi.py才行，如果要改名字请上flask官网看设置FLASK_APP的方法，cmd，bash，powershell的方法都不一样。网址https://flask.palletsprojects.com/en/2.0.x/quickstart/
然后不用访问http://localhost:5000
进入方式是从根目录的start.html进入web页面，输入名字后开始，不能重名。
多人方面目前经过测试可以在本地从多个web页面同时进行这个游戏。

### 基本介绍
我觉得没有什么可以说的，功能都特别简单除了一些意义不明的话语，说一下我给的一些设置
首先是工作不用等待，也就是点击“加班”后马上可以进行第二次加班，不是我不能弄，而是我觉得加班不停歇才符合现实情况。与之对应的寻宝就需要限制一段时间才能一次了，这里我设置的是5秒一次，为了方便debug。
如果要添加工作限制的话在人物类创建的时候多init一个精力值属性设置为零，然后在init的线程里和寻宝精力一样每过一段时间恢复为1,然后在工作函数里多加个条件语句，精力为0则工作失败，精力为1则成功工作并将精力设置为0。设置回复时间直接改delay参数就行，单位是秒，目前设置的是5。
其他的一些设置都很好理解我就不说了。

## 代码实现过程：
这部分当然要多说一点，我就按我自己分的块来说吧，一些与本课程内容相关的我会说的详细一点。再说之前要提的是代码质量毫无疑问不高，因为毕竟是新学，而且程序里的人物，物品的类型总是在class和文档数据库内反复横跳，我写的时候都好几次被弄晕，这种东西出错调试起来极难。还要提的是pymongo在我的代码里的作用，它只是起到一个搜索索引作用，通常我会根据搜索到的id来对其它结构体进行访问，CRUD操作里很多比较简答用不着数据库里的函数的地方我就没用pymongo里的，或者有的就算用了也得不到我想要的结果，因为已经写了那么多了想要改真的很麻烦。

### base板块
使用了flask和pymongo作为核心模块，然后我用的是mongo的离线版，要求本地有安装mongodb并启动其服务。后面的collection里面比较重要的是storage，这个collection是商店商品的数据库。后面会提到当服务器开始运行时商店会随机生成若干项物品。items这个collection用来储存所有物品信息。然后it_list是储存物品class的列表，后面经常用到。player_list基本没用，储存玩家class的列表在后面。下面是一些物品基本信息，全是我瞎想出来的，建议无视。值得注意的是每件物品名字和稀有度是唯一对应的。在下面是各个稀有度物品出现的概率和幸运值对它们的作用，其实就是自己设计的一套很乱的概率算法，建议无视。下面是线程类的定义，作用是管理玩家的精力值。

### player板块
player是核心板块，玩家所有操作函数都在这个class里面。他们的共同点是所有的有涉及到玩家属性改变的函数最后都会进行一个update操作，很简单，直接$set为play.__dict__就行，之里面刚好就是玩家全属性的字典。

#### work
很简单，工作后随即增加一定金钱数，跟工作能力和幸运值有关，这里我没按原要求来，我觉得这样更有意思。。

#### treasure_hunt
寻宝函数，按照概率生成稀有度，根据稀有度在items里find出文档数据库集，然后随机选一个，注意不能选生成在商店里的。如果该稀有度没有物品就寻宝失败，请大侠重新来过。选完后从items里delete掉就不能在寻宝寻到它了。然后加入玩家的背包里。这里要提一下status这个属性，自由生成的不在商店里的物品初始设置为""也就是空的，被寻到后改成"in_inventory"表示在库存，另外"on_block"表示在商店。然后更新player在各个数据库里的信息。

#### wear_equipment
没啥可说的，戴哪个物品就在物品栏上挂上那个，记得更新换下来和穿上去的物品的status，然后更新player和item在各大列表里的信息

#### wear_ornament
也没啥可说的，看过webapp就知道我把两个饰品位分开考虑，跟上个函数是一样的

#### consign & purchase
寄售函数，不能寄售status是wearing的物品，当然在web里就没有寄售的按钮。寄售要设置价格，因为初始价格是0。寄售后在storage里面insert这个物品并修改status和其它乱七八糟的值。购买函数包括了回收功能，如果购买者和寄售者是同一人则触发收回，不消耗金钱，只修改status和一些二相关的值，顺便price也设为了0。购买物品的话如果钱不够会触发购买失败，成功购买后storage里会delete掉物品，同步更新一些包括belonging所有者的信息。多人模式下亲测可行。

最后一个函数是辅助用的没有说的必要。

### item 模块
从这里开始核心部分其实说完了，item在原本基础上没怎么改，基本属性功能之前也说过了。装备类的ability就是它提供的工作能力，饰品类的就是它提供的幸运值。比较重要的belonging和status之前都提过了没啥可说的

### generate item板块
顾名思义，是随机生成物品的板块，主要涉及到插入操作。但其实很简单，服务器开始运行时随机生成自由物品和商店出售物品，一些能力值和价格属性都是基于它的稀有度随机生成的。注意insert后同步更新所有数据结构里的信息

### local msg板块
大部分是跟web搭建有关的数据除了pls就是player类的字典，通过名字作为key就能访问到玩家的class。

### web平台相关板块
后面的全都是flask和web搭建相关的代码，跟本课程没太大关系。要说的是store板块商店里可以给定限制条件来搜索物品，但不能像mysql一样关键字检索，只能通过物品类型，稀有度，名字和是否买得起来进行搜索。
每一个板块都对应值一个功能，对应了player类里的一个函数。

### 其它
那些html也全都是我手写的，我也算是html入门了。用的最多的就是flask带有的jinja2，这东西也太方便从代码传数据到html页面里了。把数据从html页面里传回代码使用的是request模块，这个就比jiaja2难用一点了，我花的部分时间调试都是在这上面。

吐槽一下，python源代码我写了两天就搞定了，搭建web平台这些我反而花了三天。。。

## 没了想到再改。这程序肯定还有我没发现的bug，之后再说。
